---
export const prerender = false; // Not needed in 'server' mode
const AI = Astro.locals.runtime.env.AI as Ai;

let inputText;
let translatedText = '';
let error = '';
let isLoading = false;

if (Astro.request.method === 'POST') {
  try {
    const formData = await Astro.request.formData();
    inputText = formData.get('inputText') as string;
    
    if (!inputText?.trim()) {
      error = "You have to enter some text. It's just common sense.";
    } else {
      isLoading = true;
      
      const prompt = `
        You are a "MagaSpeak" translator. Your task is to translate the following text into MagaSpeak, the political dialect of the America First movement. Your translation MUST follow these principles strictly:
        1. **Core Function: Polarize Thought.** Collapse all meaning into a rigid binary: loyal vs. treacherous, strong vs. weak, good for America vs. bad for America. Eliminate all nuance.
        2. **A Vocabulary (Rally Words):** Use simple, high-affect, monosyllabic words (great, strong, sad, bad, weak, loser). Use a 4th-grade reading level.
        3. **B Vocabulary (Loyalty Codes):** Use "Fake News" for critical media, "Deep State" for obstacles, "Witch Hunt" for investigations. Incorporate slogans like "Make America Great Again". Use derogatory nicknames for opponents (Sleepy Joe, Crooked Hillary) and label dissenters as "RINOs."
        4. **C Vocabulary (Weaponized Concepts):** Use "Woke," "CRT," "Globalist," "Socialist," and "Communist" as all-encompassing terms of abuse. Use "Rigged" or "Hoax" for unfavorable results.
        5. **Grammar and Rhetoric:** Use relentless superlatives (best, greatest, worst). Use short, declarative, repetitive sentences. Project absolute confidence. Do not worry about logical consistency with past statements.
        **Translation Task:** Translate the following "Oldspeak" text into MagaSpeak. Be direct, confident, and aggressive in your tone.
        **Oldspeak Text:** "${inputText}"
        **MagaSpeak Translation:**
      `;

      const { response } = await AI.run("@cf/meta/llama-3.3-70b-instruct-fp8-fast", {
        prompt: prompt,
      });
      
      translatedText = response;
      isLoading = false;
    }
  } catch (err) {
    console.error('Translation failed:', err);
    error = "Something went wrong with the translation. The Deep State is probably interfering. Try again.";
    isLoading = false;
  }
}
---

<div>
  <form method="POST" enctype="multipart/form-data" action="/" class="space-y-4">
    <div class="mb-4">
      <label for="inputText" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
        Oldspeak (Standard English)
      </label>
      <textarea 
        id="inputText" 
        name="inputText"
        rows="6" 
        class="w-full p-3 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150" 
        placeholder="e.g., The recent economic report indicates a period of moderate growth..."
        required
      >{inputText || ''}</textarea>
    </div>
    
    <div class="text-center my-6">
      <button 
        type="submit"
        class="bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-8 rounded-lg shadow-lg transform hover:scale-105 transition-transform duration-200 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed"
        disabled={isLoading}
      >
        Translate to MagaSpeak
      </button>
    </div>

    {isLoading && (
      <div class="flex justify-center items-center my-4">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-500"></div>
        <p class="ml-4 text-gray-500 dark:text-gray-400">The best translation is coming, believe me...</p>
      </div>
    )}

    {translatedText && (
      <div>
        <label for="outputText" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          MagaSpeak
        </label>
        <div class="w-full p-4 bg-gray-100 dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded-lg min-h-[150px] whitespace-pre-wrap">
          {translatedText}
        </div>
      </div>
    )}

    {error && (
      <div class="mt-4 p-4 bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-200 rounded-lg">
        <p>{error}</p>
      </div>
    )}
  </form>
</div>