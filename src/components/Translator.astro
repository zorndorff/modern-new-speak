---
export const prerender = false; // Not needed in 'server' mode
const AI = Astro.locals.runtime.env.AI as Ai;

let inputText;
let translationMode;
let translatedText = "";
let error = "";
let isLoading = false;

if (Astro.request.method === "POST") {
  try {
    const formData = await Astro.request.formData();
    inputText = formData.get("inputText") as string;
    translationMode = formData.get("translationMode") as string;

    if (!inputText?.trim()) {
      error = "You have to enter some text. It's just common sense.";
    } else {
      isLoading = true;

      let prompt;
      if (translationMode === "newspeak") {
        prompt = `
          You are a "Newspeak" translator. Your task is to translate the following text into Newspeak, the official language of Oceania from George Orwell's 1984. Your translation MUST follow these principles strictly:
          1. **Core Function: Eliminate Unorthodox Thought.** Make heretical thoughts literally unthinkable by removing words that could express them. Reduce vocabulary to minimum necessary for Party loyalty.
          2. **A Vocabulary (Everyday Words):** Use only simple, concrete words with rigidly defined meanings. Remove all ambiguity and secondary meanings. Use regular grammar: add -ful for adjectives (speedful = rapid), -wise for adverbs (goodwise = well). Use un- for negation (ungood = bad), plus- and doubleplus- for intensification.
          3. **B Vocabulary (Political Compound Words):** Create short compound words for political concepts: goodthink (orthodoxy), crimethink (thoughtcrime), bellyfeel (blind acceptance), duckspeak (speaking without thinking), oldthink (pre-revolutionary ideas). Use abbreviated forms: Minitrue (Ministry of Truth), Minipax (Ministry of Peace/War), prolefeed (mass entertainment).
          4. **C Vocabulary (Technical Terms):** Use only essential scientific/technical terms, stripped of broader meanings. No word for "Science" as general concept - covered by "Ingsoc."
          5. **Grammar Rules:** Perfect regularity - all verbs end in -ed for past tense (thinked, stealed). All plurals add -s/-es (mans, oxes). All comparatives use -er/-est (gooder, goodest). Remove irregular forms completely.
          **Translation Task:** Translate the following "Oldspeak" text into Newspeak. Eliminate nuance, compress complex ideas into simple terms, and ensure orthodoxy to Ingsoc principles.
          **Oldspeak Text:** "${inputText}"
          **Newspeak Translation:**
        `;
      } else {
        prompt = `
          You are a "MagaSpeak" translator. Your task is to translate the following text into MagaSpeak, the political dialect of the America First movement. Your translation MUST follow these principles strictly:
          1. **Core Function: Polarize Thought.** Collapse all meaning into a rigid binary: loyal vs. treacherous, strong vs. weak, good for America vs. bad for America. Eliminate all nuance.
          2. **A Vocabulary (Rally Words):** Use simple, high-affect, monosyllabic words (great, strong, sad, bad, weak, loser). Use a 4th-grade reading level.
          3. **B Vocabulary (Loyalty Codes):** Use "Fake News" for critical media, "Deep State" for obstacles, "Witch Hunt" for investigations. Incorporate slogans like "Make America Great Again". Use derogatory nicknames for opponents (Sleepy Joe, Crooked Hillary) and label dissenters as "RINOs."
          4. **C Vocabulary (Weaponized Concepts):** Use "Woke," "CRT," "Globalist," "Socialist," and "Communist" as all-encompassing terms of abuse. Use "Rigged" or "Hoax" for unfavorable results.
          5. **Grammar and Rhetoric:** Use relentless superlatives (best, greatest, worst). Use short, declarative, repetitive sentences. Project absolute confidence. Do not worry about logical consistency with past statements.
          **Translation Task:** Translate the following "Oldspeak" text into MagaSpeak. Be direct, confident, and aggressive in your tone.
          **Oldspeak Text:** "${inputText}"
          **MagaSpeak Translation:**
        `;
      }

      const { response } = await AI.run(
        "@cf/meta/llama-3.3-70b-instruct-fp8-fast",
        {
          prompt: prompt,
        }
      );

      translatedText = response;
      isLoading = false;
    }
  } catch (err) {
    console.error("Translation failed:", err);
    error =
      "Something went wrong with the translation. The Deep State is probably interfering. Try again.";
    isLoading = false;
  }
}
---

<div>
  <form
    method="POST"
    enctype="multipart/form-data"
    action="/"
    class="space-y-luxury"
    id="translatorForm"
  >
    <div class="mb-luxury">
      <label
        class="block text-lg font-executive text-navy-700 mb-executive"
      >
        Translation Mode
      </label>
      <div class="flex space-x-luxury mb-luxury">
        <label class="flex items-center opulent-card p-executive rounded-jewel hover:shadow-golden-md transition-all duration-300">
          <input
            type="radio"
            name="translationMode"
            value="magaspeak"
            class="mr-executive accent-power-500"
            checked={!translationMode || translationMode === "magaspeak"}
          />
          <span class="text-power-600 font-executive font-bold">MagaSpeak</span>
        </label>
        <label class="flex items-center opulent-card p-executive rounded-jewel hover:shadow-golden-md transition-all duration-300">
          <input
            type="radio"
            name="translationMode"
            value="newspeak"
            class="mr-executive accent-navy-500"
            checked={translationMode === "newspeak"}
          />
          <span class="text-navy-600 font-executive font-bold">Newspeak (1984)</span>
        </label>
      </div>
    </div>

    <div class="mb-luxury">
      <label
        for="inputText"
        class="block text-lg font-executive text-navy-700 mb-executive"
      >
        Oldspeak (Standard English)
      </label>
      <textarea
        id="inputText"
        name="inputText"
        rows="6"
        class="w-full p-executive bg-diamond-100 border-2 border-bling-400 rounded-jewel focus:ring-4 focus:ring-bling-300 focus:border-bling-600 transition duration-300 font-gilded text-navy-800 shadow-golden-sm"
        placeholder="e.g., The recent economic report indicates a period of moderate growth..."
        required>{inputText || ""}</textarea
      >
      
      <div class="mt-executive">
        <p class="text-sm font-executive text-navy-600 mb-executive">Quick examples (click to use):</p>
        <div class="flex flex-wrap gap-executive">
          <button
            type="button"
            class="example-link text-sm px-executive py-2 bg-emerald-100 text-emerald-700 rounded-crown hover:bg-emerald-200 hover:shadow-golden-sm transition-all duration-300 font-executive border border-emerald-300"
            data-example="The recent economic reports show slowing job growth"
          >
            Economic Report Example
          </button>
          <button
            type="button"
            class="example-link text-sm px-executive py-2 bg-navy-100 text-navy-700 rounded-crown hover:bg-navy-200 hover:shadow-golden-sm transition-all duration-300 font-executive border border-navy-300"
            data-example="The job growth numbers show a 1% gain amongst Coal and Oil"
          >
            Energy Jobs Example
          </button>
          <button
            type="button"
            class="example-link text-sm px-executive py-2 bg-bling-100 text-bling-800 rounded-crown hover:bg-bling-200 hover:shadow-golden-sm transition-all duration-300 font-executive border border-bling-300"
            data-example="Solar power shown to be the most inexpensive option per KW to install"
          >
            Solar Power Example
          </button>
        </div>
      </div>
    </div>

    <div class="text-center my-opulent">
      <button
        type="submit"
        id="submitButton"
        class="luxury-button py-luxury px-supreme rounded-treasure shadow-golden-lg transform hover:scale-105 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed text-xl"
        disabled={isLoading}
      >
        Translate to {translationMode === "newspeak" ? "Newspeak" : "MagaSpeak"}
      </button>
    </div>

    <!-- Loading indicator (initially hidden, shown by JavaScript) -->
    <div
      id="loadingIndicator"
      class="hidden flex-col justify-center items-center my-opulent p-opulent golden-gradient rounded-palace border-4 border-bling-500 shadow-golden-xl"
    >
      <div class="relative">
        <div
          class="animate-spin rounded-full h-20 w-20 border-4 border-bling-200 border-t-bling-600"
        >
        </div>
        <div
          class="absolute inset-0 animate-pulse rounded-full h-20 w-20 border-4 border-transparent border-t-diamond-500 opacity-80"
          style="animation-delay: 0.2s;"
        >
        </div>
      </div>
      <div class="mt-luxury text-center">
        <p
          class="text-xl font-executive text-navy-800 animate-pulse font-bold"
          id="loadingText"
        >
          Making America's Language Great Again...
        </p>
        <p class="text-lg font-gilded text-navy-700 mt-executive">
          The best translation is coming, believe me. It's going to be tremendous!
        </p>
      </div>
      <div class="flex space-x-executive mt-luxury">
        <div class="w-3 h-3 bg-power-500 rounded-full animate-bounce"></div>
        <div
          class="w-3 h-3 bg-diamond-500 rounded-full animate-bounce"
          style="animation-delay: 0.1s;"
        >
        </div>
        <div
          class="w-3 h-3 bg-navy-500 rounded-full animate-bounce"
          style="animation-delay: 0.2s;"
        >
        </div>
      </div>
    </div>

    <!-- Server-side loading state (backup) -->
    {
      isLoading && (
        <div class="flex flex-col justify-center items-center my-8 p-6 bg-gradient-to-r from-red-50 to-blue-50 dark:from-red-900/20 dark:to-blue-900/20 rounded-lg border-2 border-dashed border-red-300 dark:border-red-600">
          <div class="relative">
            <div class="animate-spin rounded-full h-16 w-16 border-4 border-red-200 border-t-red-600" />
            <div
              class="absolute inset-0 animate-pulse rounded-full h-16 w-16 border-4 border-transparent border-t-blue-400 opacity-60"
              style="animation-delay: 0.2s;"
            />
          </div>
          <div class="mt-4 text-center">
            <p class="text-lg font-semibold text-red-600 dark:text-red-400 animate-pulse">
              {translationMode === "newspeak"
                ? "Compressing language for Party compliance..."
                : "Making America's Language Great Again..."}
            </p>
            <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
              The best translation is coming, believe me. It's going to be
              tremendous!
            </p>
          </div>
          <div class="flex space-x-1 mt-3">
            <div class="w-2 h-2 bg-red-500 rounded-full animate-bounce" />
            <div
              class="w-2 h-2 bg-white rounded-full animate-bounce"
              style="animation-delay: 0.1s;"
            />
            <div
              class="w-2 h-2 bg-blue-500 rounded-full animate-bounce"
              style="animation-delay: 0.2s;"
            />
          </div>
        </div>
      )
    }

    {
      translatedText && (
        <div class="mt-opulent">
          <label
            for="outputText"
            class="block text-lg font-executive text-navy-700 mb-executive"
          >
            {translationMode === "newspeak" ? "Newspeak (1984)" : "MagaSpeak"}
          </label>
          <div class="w-full p-luxury bg-diamond-50 border-2 border-bling-500 rounded-treasure min-h-[200px] whitespace-pre-wrap font-gilded text-navy-800 text-lg leading-relaxed shadow-golden-md">
            {translatedText}
          </div>
        </div>
      )
    }

    {
      error && (
        <div class="mt-luxury p-luxury bg-power-100 border-2 border-power-500 text-power-800 rounded-treasure shadow-golden-sm">
          <p class="font-executive text-lg font-bold">{error}</p>
        </div>
      )
    }
  </form>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const form = document.getElementById("translatorForm");
      const loadingIndicator = document.getElementById("loadingIndicator");
      const submitButton = document.getElementById("submitButton");
      const loadingText = document.getElementById("loadingText");
      const inputTextarea = document.getElementById("inputText");
      const exampleLinks = document.querySelectorAll(".example-link");

      // Handle example button clicks
      exampleLinks.forEach(link => {
        link.addEventListener("click", () => {
          const exampleText = link.getAttribute("data-example");
          if (inputTextarea && exampleText) {
            inputTextarea.value = exampleText;
            inputTextarea.focus();
          }
        });
      });

      form?.addEventListener("submit", () => {
        // Get the selected translation mode
        const selectedMode = document.querySelector(
          'input[name="translationMode"]:checked'
        )?.value;

        // Update loading text based on mode
        if (loadingText) {
          loadingText.textContent =
            selectedMode === "newspeak"
              ? "Compressing language for Party compliance..."
              : "Making America's Language Great Again...";
        }

        // Show loading indicator
        if (loadingIndicator) {
          loadingIndicator.classList.remove("hidden");
          loadingIndicator.classList.add("flex");
        }

        // Disable submit button
        if (submitButton) {
          submitButton.disabled = true;
          submitButton.textContent = "Translating...";
        }
      });
    });
  </script>
</div>
